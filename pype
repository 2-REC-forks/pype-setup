#!/usr/bin/env bash
#
# Pype command
#

ARGS=$@

CONDA_SHARED="/tmp"
LOCAL_ENV_DIR="$CONDA_SHARED/$AVALON_ENV_NAME"
SYNC_ENV=0 # will synchronize remote with local
REMOTE_ENV_ON=0 # will switch to remote
export PYPE_DEBUG=0
export PYPE_DEBUG_STDOUT=0


print_dependency_help () {
  cat <<-EOF
Successfull installation of Pype needs few system tools already installed.
We need wget, git, gcc, md5sum and rsync. Please refer to your system's user guide how
to install them. To make all more readable, update rsync to > 3.1.0.
EOF
}

launch_conda () {
  echo -e "${ICyan}---${RST} Setting environment ..."

  export PYPE_STUDIO_TEMPLATES="$PYPE_SETUP_ROOT/repos/pype-templates"

  echo -e "${IGreen}>>>${RST} launching Conda ..."
  # Launch Conda
  source "$PYPE_SETUP_ROOT/bin/launch_conda.sh"
}

# Full path of the current script
THIS=`readlink -f "${BASH_SOURCE[0]}" 2>/dev/null||echo $0`
# The directory where current script resides
DIR=`dirname "${THIS}"`

export PYPE_SETUP_ROOT="$(cd $DIR; pwd)"

source "$PYPE_SETUP_ROOT/bin/colors.sh"

echo -e "${IGreen}>>>${RST} ${BIWhite}Welcome to Pipe Club${RST}"
# test system dependencies
echo -e "${IGreen}>>>${RST} Checking for dependencies ..."
echo -e "${BIYellow}---${RST} looking for ${BIWhite}[ git ]${RST} ... \c"
command -v git >/dev/null 2>&1 || { echo -e "${BIRed}FAILED${RST}"; print_dependency_help; exit 1; }
echo -e "${BIGreen}OK${RST}"
echo -e "${BIYellow}---${RST} looking for ${BIWhite}[ rsync ]${RST} ... \c"
command -v wget >/dev/null 2>&1 || { echo -e "${BIRed}FAILED${RST}"; print_dependency_help; exit 1; }
echo -e "${BIGreen}OK${RST}"
echo -e "${BIYellow}---${RST} checking ${BIWhite}[ rsync ]${RST} version ... \c"
RSYNC_VERSION="$(rsync --version | awk 'NR==1 {print $3}')"
oIFS="$IFS"
IFS=.
set -- $RSYNC_VERSION
IFS="$oIFS"
RSYNC_PROGRESS=0
if [ "$1" -ge "3" ] && [ "$2" -ge "1" ] && [ "$3" -ge "0" ] ; then
echo -e "${BIGreen}$1.$2.$3${RST}"
RSYNC_PROGRESS=1
else
echo -e "${BIYellow}old - $1.$2.$3${RST}"
fi
echo -e "${BIYellow}---${RST} looking for ${BIWhite}[ md5sum ]${RST} ... \c"
command -v md5sum >/dev/null 2>&1 || { echo -e "${BIRed}FAILED${RST}"; print_dependency_help; exit 1; }
echo -e "${BIGreen}OK${RST}"

echo -e "${IGreen}>>>${RST} Checking environment ..."

if [ ! -d "$LOCAL_ENV_DIR" ] ; then
  launch_conda
fi
if [[ ":$PYTHONPATH:" != *":$PYPE_SETUP_ROOT:"* ]]; then
  launch_conda
fi
python "$PYPE_SETUP_ROOT/app/pype-start.py" "$ARGS"
